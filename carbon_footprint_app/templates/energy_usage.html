<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classement des Pays par Source d'Énergie pour la Production d'Électricité en 2015</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>Classement des Pays par Source d'Énergie pour la Production d'Électricité en 2015</h1>
    <label for="energy-source">Sélectionnez une source d'énergie :</label>
    <select id="energy-source" onchange="updateChart()">
        <option value="coal_emissions" {% if energy_source == 'coal_emissions' %}selected{% endif %}>Charbon</option>
        <option value="gas_emissions" {% if energy_source == 'gas_emissions' %}selected{% endif %}>Gaz</option>
        <option value="oil_emissions" {% if energy_source == 'oil_emissions' %}selected{% endif %}>Pétrole</option>
        <option value="hydro_emissions" {% if energy_source == 'hydro_emissions' %}selected{% endif %}>Hydroélectrique</option>
        <option value="renewable_emissions" {% if energy_source == 'renewable_emissions' %}selected{% endif %}>Renouvelables</option>
        <option value="nuclear_emissions" {% if energy_source == 'nuclear_emissions' %}selected{% endif %}>Nucléaire</option>
    </select>
    <div id="bar-chart"></div>
    <div id="description" style="display: flex; align-items: center;">
        <div id="description-text"></div>
        <div id="gauge-chart" style="margin-left: 20px;"></div>
    </div>

    <script>
        var data = {
            country: {{ data['country']|tojson }},
            coal_emissions: {{ data['coal_emissions']|tojson }},
            gas_emissions: {{ data['gas_emissions']|tojson }},
            oil_emissions: {{ data['oil_emissions']|tojson }},
            hydro_emissions: {{ data['hydro_emissions']|tojson }},
            renewable_emissions: {{ data['renewable_emissions']|tojson }},
            nuclear_emissions: {{ data['nuclear_emissions']|tojson }}
        };

        var energySourceLabels = {
            'coal_emissions': 'Charbon',
            'gas_emissions': 'Gaz',
            'oil_emissions': 'Pétrole',
            'hydro_emissions': 'Hydroélectrique',
            'renewable_emissions': 'Renouvelables',
            'nuclear_emissions': 'Nucléaire'
        };

        function getColorScale(energySource) {
            switch (energySource) {
                case 'coal_emissions':
                    return ['#d3d3d3', '#a9a9a9']; // Dégradé de gris clair
                case 'gas_emissions':
                    return ['#ffcc99', '#ff6600']; // Dégradé d'orange
                case 'oil_emissions':
                    return ['#a9a9a9', '#696969']; // Dégradé de gris foncé
                case 'hydro_emissions':
                    return ['#99ccff', '#0066cc']; // Dégradé de bleu
                case 'renewable_emissions':
                    return ['#99ff99', '#009933']; // Dégradé de vert
                case 'nuclear_emissions':
                    return ['#e6ccff', '#9933cc']; // Dégradé de violet
                default:
                    return ['#ffffff', '#000000']; // Dégradé par défaut
            }
        }

        function updateChart() {
            var energySource = document.getElementById('energy-source').value;
            var sortedData = data.country.map((country, index) => ({
                country: country,
                value: data[energySource][index]
            })).sort((a, b) => b.value - a.value);

            var includedData = sortedData.filter(item => item.value > 0);
            var excludedData = sortedData.filter(item => item.value === 0);

            var colorScale = getColorScale(energySource);
            var colors = includedData.map(item => {
                var ratio = item.value / Math.max(...includedData.map(d => d.value));
                return `rgba(${parseInt(colorScale[0].slice(1, 3), 16) * (1 - ratio) + parseInt(colorScale[1].slice(1, 3), 16) * ratio}, ${parseInt(colorScale[0].slice(3, 5), 16) * (1 - ratio) + parseInt(colorScale[1].slice(3, 5), 16) * ratio}, ${parseInt(colorScale[0].slice(5, 7), 16) * (1 - ratio) + parseInt(colorScale[1].slice(5, 7), 16) * ratio}, 1)`;
            });

            var chartData = [{
                x: includedData.map(item => item.country),
                y: includedData.map(item => item.value),
                type: 'bar',
                text: includedData.map(item => `${item.country}: ${item.value}%`), // Ajout des pays et des valeurs en pourcentage dans les info-bulles
                textposition: 'inside', // Position du texte à l'intérieur des barres
                insidetextanchor: 'middle', // Ancrage du texte au milieu
                hoverinfo: 'text+y', // Affichage des pays et des valeurs dans les info-bulles
                marker: { color: colors } // Application des couleurs
            }];

            var layout = {
                xaxis: { 
                    title: 'Pays',
                    showticklabels: false // Retirer les étiquettes des pays de l'axe des x
                },
                yaxis: { 
                    title: 'Pourcentage de ' + energySourceLabels[energySource].replace(/(.{1,15})(\s|$)/g, "$1<br>") + ' dans la production d\'électricité',
                    type: 'log' // Utilisation d'une échelle logarithmique
                }
            };

            Plotly.newPlot('bar-chart', chartData, layout);

            // Mise à jour de la description
            var totalCountries = data.country.length;
            var displayedCountries = includedData.length;
            var percentageRepresentation = ((displayedCountries / totalCountries) * 100).toFixed(2);

            var description = `
                <p>Dans ce classement, nous constatons que pour ${energySourceLabels[energySource]}, nous avons ${displayedCountries} pays utilisant cette source d'énergie sur les ${totalCountries} pays de la base de données.</p> 
                <p>Cela représente ${percentageRepresentation}% des pays de la base de données utilisant cette source d'énergie.</p>
            `;

            document.getElementById('description-text').innerHTML = description;

            // Ajout de la jauge
            var gaugeData = [{
                type: "indicator",
                mode: "gauge+number",
                value: parseFloat(percentageRepresentation),
                title: { text: "Pourcentage de Pays Utilisant " + energySourceLabels[energySource], font: { size: 18 } }, // Réduire la taille de la police
                gauge: {
                    axis: { range: [0, 100], tickwidth: 1, tickcolor: "darkblue" },
                    bar: { color: "darkred" },
                    bgcolor: "gray",
                    borderwidth: 2,
                    bordercolor: "black",
                    steps: [
                        { range: [0, 50], color: "orange" },
                        { range: [50, 100], color: "green" }
                    ],
                }
            }];

            var gaugeLayout = { 
                width: 400,  // Augmenter la largeur
                height: 300, // Augmenter la hauteur
                margin: { t: 50, r: 50, l: 50, b: 50 } // Ajuster les marges
            };

            Plotly.newPlot('gauge-chart', gaugeData, gaugeLayout);
        }


        // Initial chart
        updateChart();
    </script>
</body>
</html>
